<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hotater</title>
    <style>
        html {
            background-color: #210;
            color: #fed;
        }

        canvas {
            border: 1px solid #fed;
        }
    </style>
</head>

<body>
    <h1>hotater</h1>
    <p>is up and running!</p>

    <pre id="output"></pre>

    <canvas id="in_sec" width="720" height="100"></canvas>
    <canvas id="out_sec" width="720" height="100"></canvas>
    <canvas id="users_sec" width="720" height="100"></canvas>
    <canvas id="in_min" width="720" height="100"></canvas>
    <canvas id="out_min" width="720" height="100"></canvas>
    <canvas id="users_min" width="720" height="100"></canvas>
    <canvas id="in_hr" width="720" height="100"></canvas>
    <canvas id="out_hr" width="720" height="100"></canvas>
    <canvas id="users_hr" width="720" height="100"></canvas>

    <script>
        let interval = 1024
        let stats = {}
        let sec_max = 10, min_max = 10, hr_max = 10
        let users_sec_max = 10, users_min_max = 10, users_hr_max = 10

        async function update() {
            try {
                let resp = await fetch("ws/chat")
                stats = await resp.json()
            } catch (error) { }

            if (!stats.serverStartTime) interval *= 2
            else if ((stats.in.min[stats.updateTime.min] + stats.out.min[stats.updateTime.min])) interval /= 2
            else interval *= 2
            interval = Math.max(interval, 1024)
            document.getElementById("output").textContent =
                `Server start at ${(new Date(stats.serverStartTime)).toString()}\n` +
                `This update  at ${new Date()}\n` +
                `Next update  at ${new Date(Date.now() + interval)}\n\n`
            setTimeout(update, interval)

            let fill = "#987"
            let canvas = document.querySelector("canvas")
            let g = canvas.getContext("2d")
            let k = canvas.height / sec_max


            canvas = document.getElementById("in_sec")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let sec = 0; sec < 60; sec++) {
                let i = (stats.updateTime.sec + sec) % 60
                g.fillRect(sec * 12, 100 - stats.in.sec[i] * k, 12, 100)
                sec_max = Math.max(sec_max, stats.in.sec[i] || 0)
            }
            canvas = document.getElementById("out_sec")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let sec = 0; sec < 60; sec++) {
                let i = (stats.updateTime.sec + sec) % 60
                g.fillRect(sec * 12, 100 - stats.out.sec[i] * k, 12, 1024)
                sec_max = Math.max(sec_max, stats.out.sec[i] || 0)
            }
            k = canvas.height / users_sec_max
            canvas = document.getElementById("users_sec")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let sec = 0; sec < 60; sec++) {
                let i = (stats.updateTime.sec + sec) % 60
                g.fillRect(sec * 12, 100 - stats.users.sec[i] * k, 12, 1024)
                users_sec_max = Math.max(users_sec_max, stats.users.sec[i] || 0)
            }

            k = canvas.height / min_max

            canvas = document.getElementById("in_min")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let min = 0; min < 60; min++) {
                let i = (stats.updateTime.min + min) % 60
                g.fillRect(min * 12, 100 - stats.in.min[i] * k, 12, 100)
                min_max = Math.max(min_max, stats.in.min[i] || 0)
            }
            canvas = document.getElementById("out_min")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let min = 0; min < 60; min++) {
                let i = (stats.updateTime.min + min) % 60
                g.fillRect(min * 12, 100 - stats.out.min[i] * k, 12, 1024)
                min_max = Math.max(min_max, stats.out.min[i] || 0)
            }
            k = canvas.height / users_min_max
            canvas = document.getElementById("users_min")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let min = 0; min < 60; min++) {
                let i = (stats.updateTime.min + min) % 60
                g.fillRect(min * 12, 100 - stats.users.min[i] * k, 12, 1024)
                users_min_max = Math.max(users_min_max, stats.users.min[i] || 0)
            }

            k = canvas.height / hr_max

            canvas = document.getElementById("in_hr")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let hr = 0; hr < 24; hr++) {
                let i = (stats.updateTime.hr + hr) % 24
                g.fillRect(hr * 30, 100 - stats.in.hr[i] * k, 30, 100)
                hr_max = Math.max(hr_max, stats.in.hr[i] || 0)
            }
            canvas = document.getElementById("out_hr")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let hr = 0; hr < 24; hr++) {
                let i = (stats.updateTime.hr + hr) % 24
                g.fillRect(hr * 30, 100 - stats.out.hr[i] * k, 30, 1024)
                hr_max = Math.max(hr_max, stats.out.hr[i] || 0)
            }
            k = canvas.height / users_hr_max
            canvas = document.getElementById("users_hr")
            g = canvas.getContext("2d")
            g.clearRect(0, 0, 1024, 1024)
            g.fillStyle = fill
            for (let hr = 0; hr < 24; hr++) {
                let i = (stats.updateTime.hr + hr) % 24
                g.fillRect(hr * 30, 100 - stats.users.hr[i] * k, 30, 1024)
                users_hr_max = Math.max(users_hr_max, stats.users.hr[i] || 0)
            }
        }
        update()
    </script>
</body>

</html>