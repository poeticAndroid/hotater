<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hotater</title>
    <style>
        html {
            background-color: #210;
            color: #fed;
        }

        canvas {
            border: 1px solid #fed;
        }
    </style>
</head>

<body>
    <h1>hotater</h1>
    <p>is up and running!</p>

    <pre id="output"></pre>

    <h2>per second</h2>
    <canvas id="in_sec" width="720" height="256"></canvas>
    <canvas id="out_sec" width="720" height="256"></canvas>
    <canvas id="users_sec" width="720" height="256"></canvas>
    <h2>per minute</h2>
    <canvas id="in_min" width="720" height="256"></canvas>
    <canvas id="out_min" width="720" height="256"></canvas>
    <canvas id="users_min" width="720" height="256"></canvas>
    <h2>per hour</h2>
    <canvas id="in_hr" width="720" height="256"></canvas>
    <canvas id="out_hr" width="720" height="256"></canvas>
    <canvas id="users_hr" width="720" height="256"></canvas>

    <script>
        let interval = 1024
        let stats = {}
        let zoom = {
            inout: { sec: 1, min: 1, hr: 1 },
            users: { sec: 1, min: 1, hr: 1 }
        }
        let fill = "#987"

        async function update() {
            try {
                let resp = await fetch("ws/chat")
                stats = await resp.json()
            } catch (error) {
                stats = {}
                zoom = {
                    inout: { sec: 1, min: 1, hr: 1 },
                    users: { sec: 1, min: 1, hr: 1 }
                }
            }

            if (!stats.serverStartTime) interval *= 2
            else if ((stats.in.min[stats.updateTime.min] + stats.out.min[stats.updateTime.min])) interval /= 2
            else interval *= 2
            interval = Math.max(interval, 1024)
            document.getElementById("output").textContent =
                `Server start at ${(new Date(stats.serverStartTime)).toString()}\n` +
                `This update  at ${new Date()}\n` +
                `Next update  at ${new Date(Date.now() + interval)}\n\n`
            setTimeout(update, interval)

            let canvas = document.querySelector("canvas")
            let g = canvas.getContext("2d")
            let fill = "#987"
            let sum = 0

            // seconds
            updateCanvas("in", "sec")
            updateCanvas("out", "sec")
            updateCanvas("users", "sec")

            // minutes
            updateCanvas("in", "min")
            updateCanvas("out", "min")
            updateCanvas("users", "min")

            // hours
            updateCanvas("in", "hr")
            updateCanvas("out", "hr")
            updateCanvas("users", "hr")
        }
        update()

        function updateCanvas(prop, int) {
            let canvas = document.getElementById(`${prop}_${int}`)
            let k = canvas.height / zoom[prop == "users" ? "users" : "inout"][int]
            let g = canvas.getContext("2d")
            let len = int == "hr" ? 24 : 60
            let sum = 0, max = 0
            g.clearRect(0, 0, canvas.width, canvas.height)
            g.fillStyle = fill
            for (let t = 0; t < len; t++) {
                let i = (stats.updateTime[int] + t) % len
                g.fillRect(t * (canvas.width / len), canvas.height - stats[prop][int][i] * k, canvas.width / len, canvas.height)
                if (stats[prop][int][i] > zoom[prop == "users" ? "users" : "inout"][int])
                    zoom[prop == "users" ? "users" : "inout"][int] *= 2
                if (t) sum += stats[prop][int][i] || 0
                max = Math.max(max, stats[prop][int][i] || 0)
            }
            len--
            canvas.title = `avr: ${prop == "users" ? (sum / len) : human(sum / len)} ${prop} per ${int}\nmax: ${prop == "users" ? (max) : human(max)} ${prop} per ${int}`
        }

        function human(bytes) {
            let unit = "bytes"
            if (bytes > 1024) {
                bytes /= 1024
                unit = "KiB"
            }
            if (bytes > 1024) {
                bytes /= 1024
                unit = "MiB"
            }
            if (bytes > 1024) {
                bytes /= 1024
                unit = "GiB"
            }
            if (bytes > 1024) {
                bytes /= 1024
                unit = "TiB"
            }
            return `${bytes} ${unit}`
        }
    </script>
</body>

</html>